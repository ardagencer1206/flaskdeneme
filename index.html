<!doctype html>
<html lang="tr" data-bs-theme="light">
<head>
  <meta charset="utf-8" />
  <title>Heterojen Filolu Ã‡ok DuruÅŸlu Lojistik Optimizasyonu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { background: var(--bs-body-bg); }
    pre.code { white-space: pre-wrap; font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <header class="bg-body-tertiary border-bottom">
    <div class="container py-4">
      <h1 class="h4 mb-1">Bitirmede Saplama" Heterojen Filolu Ã‡ok DuruÅŸlu Lojistik Optimizasyonu</h1>
      <p class="text-secondary mb-0">TÃ¼m parametreleri gir, <b>Ã‡Ã¶z</b> butonuna bas â€” sunucu Pyomo ile modeli kurup Ã§Ã¶zÃ¼yor.</p>
    </div>
  </header>

  <main class="container my-4">
    <div class="row g-4">
      <!-- Form -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="h6 mb-3">ğŸ”§ Model Girdileri</h3>

            <div class="mb-3">
              <label for="cities" class="form-label">Åehirler (JSON dizi)</label>
              <input id="cities" class="form-control" value='["Ä°stanbul","Ankara","Ä°zmir"]' />
              <div class="form-text">Ã–rn: <code>["Ä°stanbul","Ankara"]</code></div>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-12 col-md-6">
                <label for="main_depot" class="form-label">Ana Depo</label>
                <input id="main_depot" class="form-control" value="Ä°stanbul" />
              </div>
              <div class="col-12 col-md-6">
                <label for="periods" class="form-label">DÃ¶nem SayÄ±sÄ± (t=1..N)</label>
                <input id="periods" type="number" min="1" class="form-control" value="6" />
              </div>
            </div>

            <div class="mb-3">
              <label for="vehicle_types" class="form-label">AraÃ§ Tipleri (JSON)</label>
              <textarea id="vehicle_types" class="form-control" rows="6">{
  "KÃ¼Ã§Ã¼k": {"kapasite": 200, "maliyet_km": 2.5, "sabit_maliyet": 150, "min_doluluk": 0.4},
  "Orta":  {"kapasite": 400, "maliyet_km": 4.0, "sabit_maliyet": 300, "min_doluluk": 0.4}
}</textarea>
              <div class="form-text">Anahtarlar, <b>AraÃ§ SayÄ±larÄ±</b> bÃ¶lÃ¼mÃ¼nde kullanÄ±lacak tip adlarÄ±dÄ±r.</div>
            </div>

            <div class="mb-3">
              <label for="vehicle_count" class="form-label">AraÃ§ SayÄ±larÄ± (JSON)</label>
              <textarea id="vehicle_count" class="form-control" rows="4">{
  "KÃ¼Ã§Ã¼k": 2,
  "Orta": 1
}</textarea>
            </div>

            <div class="mb-3">
              <label for="distances" class="form-label">Mesafeler (liste; [i, j, km])</label>
              <textarea id="distances" class="form-control" rows="5">[
  ["Ä°stanbul","Ankara",450],
  ["Ä°stanbul","Ä°zmir",330],
  ["Ankara","Ä°zmir",590]
]</textarea>
              <div class="form-text">Tek yÃ¶n girmen yeterli; simetrik tamamlanÄ±r. iâ†’i = 0 kabul edilir.</div>
            </div>

            <div class="mb-3">
              <label for="packages" class="form-label">Paketler (liste)</label>
              <textarea id="packages" class="form-control" rows="7">[
  {"id":"P1","baslangic":"Ankara","hedef":"Ä°zmir","agirlik":80,"ready":1,"deadline_suresi":5,"ceza":100},
  {"id":"P2","baslangic":"Ä°zmir","hedef":"Ankara","agirlik":90,"ready":1,"deadline_suresi":5,"ceza":100},
  {"id":"P3","baslangic":"Ankara","hedef":"Ä°zmir","agirlik":70,"ready":2,"deadline_suresi":4,"ceza":100},
  {"id":"P4","baslangic":"Ä°zmir","hedef":"Ankara","agirlik":60,"ready":2,"deadline_suresi":4,"ceza":100}
]</textarea>
            </div>

            <div class="row g-3 mb-3">
              <div class="col-12 col-md-6">
                <label for="minutil_penalty" class="form-label">Min. Doluluk Ceza (TL/kg)</label>
                <input id="minutil_penalty" class="form-control" type="number" step="0.01" value="10.0" />
              </div>
              <div class="col-12 col-md-6 d-flex align-items-end">
                <div class="d-flex gap-2 w-100">
                  <button id="solveBtn" class="btn btn-primary w-100">Ã‡Ã¶z</button>
                  <button class="btn btn-outline-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#previewWrap">Ã–nizleme</button>
                </div>
              </div>
            </div>

            <div id="status" class="text-secondary small"></div>
          </div>
        </div>
      </div>

      <!-- Results -->
      <div class="col-12 col-lg-6">
        <div class="card shadow-sm">
          <div class="card-body">
            <h3 class="h6 mb-3">ğŸ“ˆ SonuÃ§lar</h3>
            <div id="results" class="text-secondary">HenÃ¼z Ã§Ã¶zÃ¼m yok. Sol taraftan verileri girip <b>Ã‡Ã¶z</b>â€™e basÄ±n.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tips & Preview -->
    <div class="card shadow-sm mt-4">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
          <h3 class="h6 mb-0"> JSON Ä°puÃ§larÄ±</h3>
          <span class="badge text-bg-light">Form doÄŸrulamasÄ± temel seviyededir</span>
        </div>
        <ul class="text-secondary mb-3">
          <li><b>Åehirler</b> dizisindeki isimler <b>mesafeler</b> ve <b>paketler</b> ile tutarlÄ± olmalÄ±.</li>
          <li><b>Mesafeler</b> tek yÃ¶n girilir; uygulama simetrik tamamlar.</li>
          <li><b>AraÃ§ Tipleri</b> anahtarlarÄ±, <b>AraÃ§ SayÄ±larÄ±</b>â€™nda kullanÄ±lmak Ã¼zere tip adlarÄ±dÄ±r.</li>
        </ul>

        <div class="collapse" id="previewWrap">
          <div class="border rounded p-3 bg-body-tertiary">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <span class="fw-semibold">Ã–rnek GÃ¶nderi (tam)</span>
              <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshPreview()">Yenile</button>
            </div>
            <pre class="code bg-dark text-light rounded p-3 mb-0" id="preview"></pre>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- App JS -->
  <script>
    const $ = (id) => document.getElementById(id);

    function parseJSONField(id, friendlyName){
      try {
        return JSON.parse($(id).value);
      } catch (e) {
        throw new Error(`${friendlyName} alanÄ± geÃ§erli JSON olmalÄ±. Hata: ${e.message}`);
      }
    }

    function buildPayload(){
      const payload = {};
      payload.cities = parseJSONField("cities", "Åehirler");
      payload.main_depot = $("main_depot").value.trim();
      payload.periods = parseInt($("periods").value, 10);
      payload.vehicle_types = parseJSONField("vehicle_types", "AraÃ§ Tipleri");
      payload.vehicle_count = parseJSONField("vehicle_count", "AraÃ§ SayÄ±larÄ±");
      payload.distances = parseJSONField("distances", "Mesafeler");
      payload.packages = parseJSONField("packages", "Paketler");
      payload.minutil_penalty = parseFloat($("minutil_penalty").value);

      if (!payload.main_depot) throw new Error("Ana Depo boÅŸ olamaz.");
      if (!Number.isFinite(payload.periods) || payload.periods < 1) throw new Error("DÃ¶nem sayÄ±sÄ± 1 veya daha bÃ¼yÃ¼k olmalÄ±.");
      return payload;
    }

    function fmtTL(x){
      const v = Number.isFinite(x) ? x : 0;
      return (Math.round(v*100)/100).toLocaleString("tr-TR",{minimumFractionDigits:2, maximumFractionDigits:2})+" TL";
    }

    function renderResults(resp){
      const el = $("results");
      if(!resp || resp.ok === false){
        const msg = (resp && resp.error) ? resp.error : "Bilinmeyen hata";
        el.innerHTML = `<div class="alert alert-warning mb-0" role="alert">âš ï¸ ${msg}</div>`;
        return;
      }
      const r = resp.result || {};
      let html = "";

      html += `<div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <span class="badge rounded-pill text-bg-primary">Ã‡Ã¶zÃ¼cÃ¼: ${resp.solver}</span>
        <span class="badge rounded-pill text-bg-success">AmaÃ§: ${fmtTL(r.objective)}</span>
      </div>`;

      const cb = r.cost_breakdown || {};
      html += `<h6 class="mt-2">Maliyet DaÄŸÄ±lÄ±mÄ±</h6>
        <div class="table-responsive"><table class="table table-sm align-middle mb-3">
          <thead class="table-light"><tr><th>Kalem</th><th>Tutar</th></tr></thead>
          <tbody>
            <tr><td>TaÅŸÄ±ma</td><td>${fmtTL(cb.transport)}</td></tr>
            <tr><td>Sabit</td><td>${fmtTL(cb.fixed)}</td></tr>
            <tr><td>Gecikme</td><td>${fmtTL(cb.lateness)}</td></tr>
            <tr><td>Min. doluluk aÃ§Ä±ÄŸÄ±</td><td>${fmtTL(cb.min_util_gap)}</td></tr>
          </tbody>
        </table></div>`;

      if ((r.vehicle_routes||[]).length){
        html += `<h6>AraÃ§ RotalarÄ±</h6>`;
        r.vehicle_routes.forEach(vr=>{
          html += `<div class="border rounded p-2 mb-2">
            <div class="fw-semibold"> ${vr.vehicle} <span class="text-secondary fw-normal">(Kapasite: ${vr.capacity} kg)</span></div>
            <div class="table-responsive"><table class="table table-sm mb-0">
              <thead class="table-light"><tr><th>t</th><th>Rota</th><th>Mesafe</th><th>YÃ¼k</th><th>Doluluk</th><th>Paketler</th></tr></thead><tbody>`;
          (vr.legs||[]).forEach(l=>{
            html += `<tr>
              <td>${l.t}</td>
              <td>${l.from} â†’ ${l.to}</td>
              <td>${l.km} km</td>
              <td>${Math.round(l.load_kg)} kg</td>
              <td>${(l.utilization_pct||0).toFixed(1)}%</td>
              <td>${(l.packages||[]).length ? l.packages.join(", ") : "â€”"}</td>
            </tr>`;
          });
          html += `</tbody></table></div></div>`;
        });
      }

      if ((r.packages||[]).length){
        html += `<h6 class="mt-3">Paketler</h6>
        <div class="table-responsive"><table class="table table-sm align-middle">
          <thead class="table-light">
            <tr><th>ID</th><th>GÃ¼zergÃ¢h</th><th>HazÄ±r</th><th>Termin (t)</th><th>Teslim</th><th>Durum</th><th>Ceza</th></tr>
          </thead><tbody>`;
        r.packages.forEach(p=>{
          const delivered = (p.delivered_at!==null && p.delivered_at!==undefined);
          html += `<tr>
            <td><b>${p.id}</b></td>
            <td>${p.origin} â†’ ${p.dest}</td>
            <td>${p.ready}</td>
            <td>${p.deadline_by}</td>
            <td>${delivered? p.delivered_at : "â€”"}</td>
            <td>${delivered? (p.on_time? " ZamanÄ±nda":" Gecikmeli") : " Teslim yok"}</td>
            <td>${fmtTL(p.lateness_penalty||0)}</td>
          </tr>`;
        });
        html += `</tbody></table></div>`;

        r.packages.forEach(p=>{
          html += `<div class="accordion mb-2" id="acc-${p.id}">
            <div class="accordion-item">
              <h2 class="accordion-header">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#col-${p.id}">
                  ğŸ›£ï¸ ${p.id} rota detay <span class="ms-2 badge text-bg-${p.passed_main_depot?'success':'secondary'}">${p.passed_main_depot?'Ana depo: Evet':'Ana depo: HayÄ±r'}</span>
                </button>
              </h2>
              <div id="col-${p.id}" class="accordion-collapse collapse" data-bs-parent="#acc-${p.id}">
                <div class="accordion-body">
                  ${
                    (p.route||[]).length
                    ? `<div class="table-responsive"><table class="table table-sm mb-0">
                        <thead class="table-light"><tr><th>t</th><th>From</th><th>To</th><th>AraÃ§</th></tr></thead>
                        <tbody>${p.route.map(seg=>`<tr><td>${seg.t}</td><td>${seg.from}</td><td>${seg.to}</td><td>${seg.vehicle}</td></tr>`).join("")}</tbody>
                       </table></div>`
                    : `<div class="text-secondary">Rota yok.</div>`
                  }
                </div>
              </div>
            </div>
          </div>`;
        });
      }

      $("results").innerHTML = html;
    }

    function setStatus(msg, type="secondary"){
      $("status").innerHTML = `<span class="text-${type}">${msg}</span>`;
    }

    function setResultsInfo(msg, type="info"){
      $("results").innerHTML = `<div class="alert alert-${type}">${msg}</div>`;
    }

    async function runSolve(payload) {
      // /solve aynÄ± origin altÄ±nda olmalÄ±; domain yazma
      const res = await fetch("/solve", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      const raw = await res.text();
      const ctype = res.headers.get("content-type") || "";
      const isJSON = ctype.includes("application/json");

      if (!isJSON) {
        throw new Error("Sunucudan JSON yerine HTML/metin geldi: " + raw.slice(0, 300));
      }

      let data;
      try {
        data = JSON.parse(raw);
      } catch (e) {
        throw new Error("JSON parse hatasÄ±: " + raw.slice(0, 300));
      }

      if (!res.ok || data.ok === false) {
        throw new Error(data.error || raw.slice(0, 300) || ("HTTP " + res.status));
      }

      return data; // { ok:true, solver, result: {...} }
    }

    $("solveBtn").addEventListener("click", async ()=>{
      $("solveBtn").disabled = true;
      setStatus("Ã‡Ã¶zÃ¼lÃ¼yorâ€¦");
      setResultsInfo("Sunucuya istek gÃ¶nderildiâ€¦", "info");
      try{
        const payload = buildPayload();
        const data = await runSolve(payload);
        renderResults(data);
        setStatus("TamamlandÄ± âœ”ï¸", "success");
      }catch(err){
        console.error(err);
        setResultsInfo("Hata: " + err.message, "danger");
        setStatus("Hata oluÅŸtu", "danger");
      }finally{
        $("solveBtn").disabled = false;
      }
    });

    function refreshPreview(){
      try{
        $("preview").textContent = JSON.stringify(buildPayload(), null, 2);
      }catch(e){
        $("preview").textContent = "Ã–rnek/payload derlenemedi:\n" + e.message;
      }
    }
    ["cities","main_depot","periods","vehicle_types","vehicle_count","distances","packages","minutil_penalty"]
      .forEach(id => $(id).addEventListener("input", refreshPreview));
    refreshPreview();
  </script>
</body>
</html>

